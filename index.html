<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SIBUR QUIZ BATTLE ¬∑ Production-ready Telegram Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!--
    –ü–†–û–î-–í–ï–†–°–ò–Ø –§–†–û–ù–¢–ï–ù–î–ê
    ----------------------
    –≠—Ç–æ—Ç —Ñ–∞–π–ª –≥–æ—Ç–æ–≤ –¥–ª—è:
    ‚Ä¢ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –Ω–∞ –ª—é–±–æ–º —Ö–æ—Å—Ç–∏–Ω–≥–µ (–≤ —Ç.—á. GitHub Pages)
    ‚Ä¢ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ Telegram Mini Apps
    ‚Ä¢ —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–Ω—ã–º API —Ä–µ–π—Ç–∏–Ω–≥–∞/–±–µ–π–¥–∂–µ–π —á–µ—Ä–µ–∑ /api/...

    –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –±—ç–∫–µ–Ω–¥—É:
    ‚Ä¢ GET  /api/profile/me
    ‚Ä¢ POST /api/duels/finish
    ‚Ä¢ GET  /api/leaderboard

    –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –±—ç–∫–µ–Ω–¥–∞ —Ñ—Ä–æ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ (localStorage).
  -->

  <style>
    :root {
      --sibur-teal: #009CA6;
      --sibur-teal-dark: #006D73;
      --sibur-teal-soft: #E3F6F7;
      --sibur-graphite: #00252B;
      --sibur-accent-yellow: #F7C948;

      --bg-main: #F3F7F8;
      --card-bg: #FFFFFF;
      --border-soft: #E2E8EA;
      --danger: #D94747;
      --success: #36A766;
      --radius-lg: 20px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #E2F5F6 0, #F7FAFB 55%, #EDF3F4 100%);
      color: var(--sibur-graphite);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      background: radial-gradient(circle at top left, #FFFFFF 0%, #F4FBFC 45%, #E7F3F5 100%);
      border-radius: 28px;
      box-shadow: 0 18px 46px rgba(0, 40, 50, 0.28);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    header.app-header {
      padding: 16px 20px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, var(--sibur-teal-dark), var(--sibur-teal));
      color: white;
    }

    .header-logo {
      font-weight: 800;
      letter-spacing: 0.08em;
      font-size: 16px;
    }

    .header-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      opacity: 0.9;
    }
.header-badge.badge-online {
background: rgba(255, 255, 255, 0.08);
border-color: rgba(255, 255, 255, 0.24);
}
.header-badge.badge-demo {
background: rgba(255, 255, 255, 0.16);
 border-color: rgba(255, 255, 255, 0.36);
}
.header-badge.badge-warning {
background: var(--sibur-accent-yellow);
color: var(--sibur-graphite);
border-color: rgba(0, 0, 0, 0.05);
}

    main {
      flex: 1;
      padding: 18px 18px 22px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .screen {
      display: none;
      flex-direction: column;
      gap: 16px;
      height: 100%;
      opacity: 0;
      transform: translateY(8px) scale(0.99);
      transition: opacity 0.22s ease, transform 0.22s ease;
    }
    .screen.active {
      display: flex;
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .card {
      background: rgba(255,255,255,0.98);
      border-radius: var(--radius-lg);
      padding: 16px 16px 14px;
      box-shadow: 0 10px 28px rgba(0, 40, 50, 0.12);
      border: 1px solid rgba(255,255,255,0.7);
    }

    .card-hero {
      background: radial-gradient(circle at top left,
      rgba(255,255,255,0.98),
      rgba(227,246,247,0.98));
      padding: 18px 18px 18px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .card-title {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.01em;
    }

    .card-subtitle {
      font-size: 13px;
      opacity: 0.8;
      margin-top: 4px;
      line-height: 1.5;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .pill-inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.04);
      font-size: 11px;
    }

    .btn {
      position: relative;
      overflow: hidden;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 15px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      transition:
        transform 0.09s ease,
        box-shadow 0.09s ease,
        background 0.12s ease,
        filter 0.12s ease;
    }
    .btn::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(255,255,255,0.5), transparent 60%);
      opacity: 0;
      transition: opacity 0.18s ease;
    }
    .btn:active::after {
      opacity: 1;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--sibur-teal), var(--sibur-teal-dark));
      color: #fff;
      box-shadow: 0 10px 24px rgba(0, 95, 110, 0.4);
    }
    .btn-primary:active {
      transform: scale(0.97) translateY(1px);
      box-shadow: 0 6px 18px rgba(0, 70, 80, 0.4);
      filter: brightness(0.97);
    }
    .btn-secondary {
      background: rgba(255,255,255,0.96);
      border: 1px solid var(--border-soft);
      color: var(--sibur-teal-dark);
      box-shadow: 0 4px 10px rgba(0, 40, 50, 0.08);
    }
    .btn-small {
      padding-block: 8px;
      font-size: 13px;
    }

    .btn-row {
      display: flex;
      gap: 10px;
    }

    
    /* ---------- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ ---------- */
    .splash-wrapper {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: stretch;
      height: 100%;
      gap: 18px;
    }
    .splash-card {
      border-radius: 28px;
      padding: 32px 24px 28px;
      background: linear-gradient(180deg, var(--sibur-teal-dark), var(--sibur-teal));
      color: #ffffff;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      box-shadow: 0 18px 40px rgba(0, 60, 70, 0.45);
    }
    .splash-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(255,255,255,0.18), transparent 55%);
      pointer-events: none;
    }
    .splash-title {
      font-size: 20px;
      font-weight: 700;
      margin-top: 80px;
      margin-bottom: 24px;
      position: relative;
      z-index: 1;
    }
    .splash-progress-outer {
      width: 100%;
      border-radius: 999px;
      background: rgba(0,0,0,0.12);
      padding: 4px;
      position: relative;
      z-index: 1;
    }
    .splash-progress-inner {
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #6FFFC8, #E0FFF4);
      color: #00434C;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      padding: 4px 0;
      transition: width 0.2s ease-out;
    }
    .splash-hero {
      margin-top: 32px;
      position: relative;
      z-index: 1;
      max-width: 220px;
    }
    .splash-hero img {
      display: block;
      width: 100%;
      height: auto;
    }

    /* ---------- –û—Ç—Å—á—ë—Ç –ø–µ—Ä–µ–¥ –¥—É—ç–ª—å—é ---------- */
    #screen-duel {
      position: relative;
    }
    .duel-countdown-overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 30;
    }
    .duel-countdown-overlay.visible {
      display: flex;
    }
    .duel-countdown-pill {
      min-width: 240px;
      min-height: 90px;
      padding: 22px 26px;
      border-radius: 40px;
      background: linear-gradient(135deg, var(--sibur-teal), var(--sibur-teal-dark));
      color: #ffffff;
      font-size: 40px;
      font-weight: 700;
      text-align: center;
      box-shadow: 0 16px 40px rgba(0, 80, 90, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ---------- –ë–∞–Ω–Ω–µ—Ä –≤–Ω–∏–∑—É –¥—É—ç–ª–∏ ---------- */
    .duel-banner {
      margin-top: 14px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 12px 28px rgba(0, 40, 50, 0.25);
    }
    .duel-banner img {
      display: block;
      width: 100%;
      height: auto;
    }

.profile-row {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .avatar {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      background: linear-gradient(145deg, #FFFFFF, #E5F5F6);
      border: 2px solid rgba(0,156,166,0.35);
      box-shadow: 0 6px 16px rgba(0, 80, 90, 0.28);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: var(--sibur-teal-dark);
      overflow: hidden;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-meta {
      font-size: 12px;
      opacity: 0.7;
    }

    .stats-row {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      font-size: 12px;
      flex-wrap: wrap;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 156, 166, 0.15);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip span.icon {
      font-size: 14px;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .menu-item {
      border-radius: var(--radius-lg);
      background: white;
      padding: 10px 11px;
      border: 1px solid rgba(0, 0, 0, 0.03);
      box-shadow: 0 4px 10px rgba(0, 40, 50, 0.04);
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s ease;
    }
    .menu-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(0, 40, 50, 0.08);
      background: rgba(255, 255, 255, 0.98);
    }
    .menu-item-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .menu-item-subtitle {
      font-size: 11px;
      opacity: 0.7;
      line-height: 1.4;
    }
    .menu-pill {
      font-size: 10px;
      margin-top: 6px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(0, 156, 166, 0.08);
      color: var(--sibur-teal-dark);
      display: inline-block;
    }

    .footer-info {
      text-align: center;
      font-size: 11px;
      opacity: 0.7;
      line-height: 1.4;
    }

    .duel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .versus-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .vs-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.7;
    }

    .score-chip {
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.04);
    }

    .timer-bar {
      position: relative;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.06);
      overflow: hidden;
      margin-bottom: 12px;
    }

    .timer-fill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--sibur-teal), var(--sibur-accent-yellow));
      transform-origin: left;
      transform: scaleX(1);
      transition: transform 0.1s linear;
    }

    .question-text {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .question-meta {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 10px;
    }

    .answers {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .answer-btn {
      width: 100%;
      border-radius: 999px;
      padding: 10px 13px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.96);
      text-align: left;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0, 40, 50, 0.06);
      transition: background 0.1s ease, border-color 0.1s ease, transform 0.06s ease, box-shadow 0.06s ease;
    }
    .answer-btn span.index {
      font-weight: 600;
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 999px;
      background: rgba(0,156,166,0.12);
      color: var(--sibur-teal-dark);
      min-width: 20px;
      text-align: center;
    }
    .answer-btn span.text {
      flex: 1;
    }
    .answer-btn.correct {
      background: rgba(54, 167, 102, 0.12);
      border-color: rgba(54, 167, 102, 0.7);
      animation: answer-pop 0.25s ease;
    }
    .answer-btn.wrong {
      background: rgba(217, 71, 71, 0.10);
      border-color: rgba(217, 71, 71, 0.75);
      animation: answer-shake 0.25s ease;
    }
    .answer-btn.disabled {
      opacity: 0.75;
      cursor: default;
    }

    @keyframes answer-pop {
      0% { transform: scale(0.98); }
      60% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    @keyframes answer-shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-3px); }
      50% { transform: translateX(3px); }
      75% { transform: translateX(-2px); }
      100% { transform: translateX(0); }
    }

    .small-label {
      font-size: 11px;
      opacity: 0.7;
    }

    .result-main-score {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 6px;
    }
    .result-status {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .result-delta {
      font-size: 12px;
      opacity: 0.8;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
    }
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .badge-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .badge-card {
      border-radius: var(--radius-lg);
      padding: 9px 10px;
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      box-shadow: 0 4px 10px rgba(0, 40, 50, 0.04);
    }
    .badge-pill {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0, 156, 166, 0.09);
      align-self: flex-start;
    }
    .badge-card.locked {
      opacity: 0.55;
    }

    .leader-header-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 6px;
    }
    .leader-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }
    .leader-row {
      display: grid;
      grid-template-columns: 26px 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.03);
      box-shadow: 0 4px 10px rgba(0,40,50,0.06);
    }
    .leader-row.me {
      background: rgba(0,156,166,0.11);
      border-color: rgba(0,156,166,0.4);
      font-weight: 600;
    }
    .leader-pos {
      font-size: 12px;
      opacity: 0.7;
      text-align: center;
    }
    .leader-name {
      display: flex;
      flex-direction: column;
    }
    .leader-name-main {
      font-size: 13px;
    }
    .leader-name-sub {
      font-size: 11px;
      opacity: 0.7;
    }
    .leader-score {
      font-size: 13px;
      font-weight: 600;
      text-align: right;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .overlay.active {
      display: flex;
    }
    .overlay-card {
      width: 100%;
      max-width: 360px;
      background: #FFFFFF;
      border-radius: 20px;
      padding: 18px 18px 16px;
      box-shadow: 0 18px 46px rgba(0,0,0,0.35);
    }

    @media (max-width: 520px) {
      .app {
        border-radius: 0;
        max-width: none;
        min-height: 100vh;
      }
      header.app-header {
        border-radius: 0;
      }
    }
	
	.bottom-nav {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      width: 100%;
      max-width: 480px;
      padding: 8px 14px 12px;
      background: rgba(255,255,255,0.98);
      box-shadow: 0 -10px 26px rgba(0, 40, 50, 0.25);
      display: flex;
      justify-content: space-between;
      gap: 6px;
      z-index: 30;
      border-radius: 22px 22px 0 0;
    }
    .bottom-nav-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 6px 4px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: rgba(0,37,43,0.7);
      cursor: pointer;
      transition: background 0.18s ease, transform 0.08s ease, color 0.18s ease;
    }
    .bottom-nav-btn-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: rgba(0, 37, 43, 0.04);
    }
    .bottom-nav-btn-label {
      line-height: 1;
    }
    .bottom-nav-btn.active {
      background: var(--sibur-teal-soft);
      color: var(--sibur-teal-dark);
    }
    .bottom-nav-btn.active .bottom-nav-btn-icon {
      background: var(--sibur-teal);
      color: #ffffff;
    }
    .bottom-nav-btn:active {
      transform: translateY(1px) scale(0.97);
    }
	
	.home-duel-card .home-duel-inner {
      display: flex;
      gap: 14px;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .home-duel-image img {
      display: block;
      width: 110px;
      height: auto;
      border-radius: 18px;
    }

    .home-duel-title {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 8px;
    }

    .home-duel-rules {
      padding-left: 18px;
      margin: 0;
      list-style: disc;
      font-size: 13px;
      line-height: 1.5;
      opacity: 0.9;
    }

    .home-duel-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .home-banner {
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 12px 28px rgba(0, 40, 50, 0.25);
    }

    .home-banner img {
      display: block;
      width: 100%;
      height: auto;
    }
.profile-row {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .avatar {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      background: linear-gradient(145deg, #FFFFFF, #E5F5F6);
      border: 2px solid rgba(0,156,166,0.35);
      box-shadow: 0 6px 16px rgba(0, 80, 90, 0.28);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: var(--sibur-teal-dark);
      overflow: hidden;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
	
	    .home-level-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 14px;
      gap: 10px;
      font-size: 13px;
    }

    .home-level-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0, 156, 166, 0.06);
      color: var(--sibur-graphite);
      font-size: 12px;
      white-space: nowrap;
    }

    .home-level-pill .icon {
      font-size: 16px;
    }

    .home-level-pill.active {
      background: rgba(0, 156, 166, 0.16);
      font-weight: 600;
    }

    .home-level-progress-bar {
      margin-top: 10px;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: var(--sibur-teal-soft);
      overflow: hidden;
    }

    .home-level-progress-fill {
      height: 100%;
      width: 30%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--sibur-teal-dark), var(--sibur-teal));
      transition: width 0.25s ease-out;
    }

	
  </style>
</head>
<body>
<!-- Overlay –ø–æ–∏—Å–∫–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ -->
<div class="overlay" id="match-overlay">
  <div class="overlay-card">
    <div style="font-weight:700;font-size:16px;margin-bottom:6px;">
      –ò—â–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞‚Ä¶
    </div>
    <div id="match-status" style="font-size:13px;opacity:0.8;margin-bottom:12px;">
      –°–º–æ—Ç—Ä–∏–º, –∫—Ç–æ —Å–µ–π—á–∞—Å –≤ –∏–≥—Ä–µ
    </div>
    <div id="match-timer"
         style="font-size:32px;font-weight:800;margin-bottom:12px;text-align:center;">
      30
    </div>
    <button class="btn btn-secondary btn-small" id="btn-match-cancel">
      –û—Ç–º–µ–Ω–∞
    </button>
  </div>
</div>

<div class="app">
  <header class="app-header">
    <div class="header-logo"></div>
    <div class="header-badge"></div>
  </header>

  <main>
    <!-- Splash -->
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ -->
    <section class="screen active" id="screen-loading">
      <div class="splash-wrapper">
        <div class="splash-card">
          <div class="splash-title">–ö–≤–∏–∑-–¥—É—ç–ª—å ¬´–ö–∞–∑–∞–Ω—å–æ—Ä–≥—Å–∏–Ω—Ç–µ–∑–∞¬ª</div>
          <div class="splash-progress-outer">
            <div class="splash-progress-inner" id="loading-progress-bar">0%</div>
          </div>
          <div class="splash-hero">
            <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å —Ç—Ä—É–±–∞–º–∏. –§–∞–π–ª –Ω–∞–∑–æ–≤–∏: splash-hero.png -->
            <img src="splash-hero.png" alt="–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–æ–¥–∞" />
          </div>
        </div>
        <div class="footer-info" id="splash-footer">
          –°—Ç–∞—Ç—É—Å: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ.
        </div>
      </div>
    </section>

<!-- Main menu -->
    <section class="screen" id="screen-main">
      <div class="home-top-gradient"></div>

      <div class="home-main-wrap">
        <div class="card home-profile-card">
          <div class="home-profile-row">
            <div class="avatar" id="player-avatar">S</div>
            <div>
              <div id="player-name" class="home-player-name">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –°–ò–ë–£–†</div>
              <div class="home-player-meta" id="player-meta">–†–µ–π—Ç–∏–Ω–≥: 100 ¬∑ –î—É—ç–ª–µ–π: 0</div>
            </div>
          </div>

          <div class="home-level-row">
            <div class="home-level-pill active" id="home-level-start">
              <span class="icon">üèÖ</span><span>–ù–æ–≤–∏—á–æ–∫</span>
            </div>
            <div class="home-level-pill" id="home-level-end">
              <span class="icon">üèÖ</span><span>–≠–∫—Å–ø–µ—Ä—Ç</span>
            </div>
          </div>

          <div class="home-level-progress-bar">
            <div class="home-level-progress-fill" id="home-level-progress"></div>
          </div>

          <!-- –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º JS -->
          <div style="display:none;">
            <span id="player-rating-label"></span>
            <span id="player-battles-label"></span>
          </div>
        </div>

        <div class="card home-duel-card">
          <div class="home-duel-inner">
            <div class="home-duel-image">
              <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º, –Ω–∞–∑–æ–≤–∏ —Ñ–∞–π–ª: home-duel-worker.png -->
              <img src="home-duel-worker.png" alt="–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ" />
            </div>
            <div class="home-duel-text">
              <div class="home-duel-title">
                –ò–≥—Ä–∞–π –≤ –¥—É—ç–ª—å –Ω–∞ –∑–Ω–∞–Ω–∏–µ ¬´–ö–∞–∑–∞–Ω—å–æ—Ä–≥—Å–∏–Ω—Ç–µ–∑–∞¬ª —Å–æ —Å–ª—É—á–∞–π–Ω—ã–º –∫–æ–ª–ª–µ–≥–æ–π
              </div>
              <ul class="home-duel-rules">
                <li>–æ—Ç–≤–µ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –±—ã—Å—Ç—Ä–µ–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –Ω–∞ 5 –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –ö–û–°–µ</li>
                <li>–≤—ã–∏–≥—Ä—ã–≤–∞–π –¥—É—ç–ª—å –∏ –ø–æ–≤—ã—à–∞–π —Ä–µ–π—Ç–∏–Ω–≥</li>
                <li>–ø–æ–ª—É—á–∞–π –Ω–æ–≤—ã–π –º–µ—Ä—á ¬´–ö–∞–∑–∞–Ω—å–æ—Ä–≥—Å–∏–Ω—Ç–µ–∑–∞¬ª</li>
              </ul>
            </div>
          </div>
          <div class="home-duel-buttons">
            <button class="btn btn-primary" id="btn-play-quick">–ò–≥—Ä–∞—Ç—å –¥—É—ç–ª—å</button>
            <button class="btn btn-secondary btn-small" id="btn-play-bot">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å –ò–ò-—Å–æ–ø–µ—Ä–Ω–∏–∫–æ–º</button>
          </div>
        </div>

        <div class="home-banner">
          <!-- –ë–æ–ª—å—à–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π, –Ω–∞–∑–æ–≤–∏ —Ñ–∞–π–ª: home-main-plant.png -->
          <img src="home-main-plant.png" alt="–ó–∞–≤–æ–¥ –ö–∞–∑–∞–Ω—å–æ—Ä–≥—Å–∏–Ω—Ç–µ–∑" />
        </div>
      </div>
    </section>

    <!-- Duel screen -->
    <section class="screen" id="screen-duel">
      <div class="card">
        <div class="duel-header">
          <span class="small-label" id="duel-mode-label">–†–µ–∂–∏–º: –ë—ã—Å—Ç—Ä–∞—è –¥—É—ç–ª—å</span>
          <span class="small-label" id="duel-progress-label">–í–æ–ø—Ä–æ—Å 1 / 5</span>
        </div>

        <div class="versus-row">
          <div style="display:flex;align-items:center;gap:8px;">
            <div class="avatar" style="width:34px;height:34px;font-size:14px;" id="duel-player-avatar">P</div>
            <div style="font-size:12px;">
              <div id="duel-player-name" style="font-weight:600;">–í—ã</div>
              <div style="opacity:0.7;">–†–µ–π—Ç–∏–Ω–≥: <span id="duel-player-rating">100</span></div>
            </div>
          </div>
          <div style="text-align:center;">
            <div class="vs-label">–î—É—ç–ª—å</div>
            <div class="score-chip" id="duel-score-label">0 : 0</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px;justify-content:flex-end;">
            <div style="font-size:12px;text-align:right;">
              <div id="duel-opponent-name" style="font-weight:600;">–°–æ–ø–µ—Ä–Ω–∏–∫</div>
              <div style="opacity:0.7;">–†–µ–π—Ç–∏–Ω–≥: <span id="duel-opponent-rating">100</span></div>
            </div>
            <div class="avatar" style="width:34px;height:34px;font-size:14px;background:linear-gradient(135deg,#ffffff,#FFE1B2);border-color:rgba(249,180,59,0.5);" id="duel-opponent-avatar">
              R
            </div>
          </div>
        </div>

        <div class="timer-bar">
          <div class="timer-fill" id="timer-fill"></div>
        </div>

        <div class="question-text" id="question-text">–í–æ–ø—Ä–æ—Å –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.</div>
        <div class="question-meta" id="question-meta">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ‚Äî</div>

        <div class="answers" id="answers-container"></div>
      </div>

      <div class="card">
        <div class="section-title">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
        <p style="font-size:12px;opacity:0.8;" id="duel-hint">
  –°–æ–ø–µ—Ä–Ω–∏–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–ª–ª–µ–≥–æ–π –∏–ª–∏ –±–æ—Ç ‚Äî –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –∫—Ç–æ —Å–µ–π—á–∞—Å –≤ –∏–≥—Ä–µ.
</p>
      </div>

      <div class="btn-row">
        <button class="btn btn-secondary btn-small" id="btn-duel-exit">–í—ã–π—Ç–∏</button>
        <button class="btn btn-small" id="btn-duel-skip">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞—É–Ω–¥</button>
      </div>
          <div class="duel-countdown-overlay" id="duel-countdown-overlay">
        <div class="duel-countdown-pill" id="duel-countdown-pill">3</div>
      </div>

      <div class="duel-banner">
        <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ –≤–Ω–∏–∑—É –¥—É—ç–ª–∏. –ù–∞–∑–æ–≤–∏ —Ñ–∞–π–ª: duel-bottom-banner.png -->
        <img src="duel-bottom-banner.png" alt="–ë–∞–Ω–Ω–µ—Ä –¥—É—ç–ª–∏" />
      </div>
    </section>


    <!-- Result screen -->
    <section class="screen" id="screen-result">
      <div class="card card-hero">
        <div class="card-header">
          <div>
            <div class="card-title">–†–µ–∑—É–ª—å—Ç–∞—Ç –¥—É—ç–ª–∏</div>
            <div class="card-subtitle" id="result-subtitle">
              –•–æ—Ä–æ—à–∞—è –∏–≥—Ä–∞! –° –∫–∞–∂–¥–æ–π –¥—É—ç–ª—å—é –≤—ã –ª—É—á—à–µ –∑–Ω–∞–µ—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é.
            </div>
          </div>
          <div class="pill-inline" id="result-mode-pill">–ë—ã—Å—Ç—Ä–∞—è –¥—É—ç–ª—å</div>
        </div>

        <div style="margin-top:10px;">
          <div class="result-main-score" id="result-score">3 : 2</div>
          <div class="result-status" id="result-status-label">–ü–æ–±–µ–¥–∞ üéâ</div>
          <div class="result-delta" id="result-delta-label">–†–µ–π—Ç–∏–Ω–≥: +15 ¬∑ –î—É—ç–ª–µ–π: +1</div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
        <div class="list">
          <div class="list-item">
            <span>–¢–µ–∫—É—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥</span>
            <span class="pill-inline">üèÖ <span id="result-rating-value">115</span></span>
          </div>
          <div class="list-item">
            <span>–í—Å–µ–≥–æ –¥—É—ç–ª–µ–π</span>
            <span class="pill-inline">‚öîÔ∏è <span id="result-battles-value">1</span></span>
          </div>
          <div class="list-item">
            <span>–ü–æ–±–µ–¥—ã / –ø–æ—Ä–∞–∂–µ–Ω–∏—è</span>
            <span class="pill-inline">üéØ <span id="result-wl-value">1 / 0 / 0</span></span>
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn btn-primary" id="btn-result-again">–°—ã–≥—Ä–∞—Ç—å –µ—â—ë –¥—É—ç–ª—å</button>
        <button class="btn btn-secondary" id="btn-result-main">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
      </div>
    </section>

    <!-- Badges screen -->
    <section class="screen" id="screen-badges">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">–ë–µ–π–¥–∂–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π</div>
            <div class="card-subtitle">–°–ø–∏—Å–æ–∫ –±–µ–π–¥–∂–µ–π –∏ —É—Å–ª–æ–≤–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è. –í –ø—Ä–æ–¥–µ –≤—ã–¥–∞—é—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º.</div>
          </div>
          <div class="pill-inline">
            ‚≠ê <span id="badges-count-label">0 –∏–∑ 5</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="badge-grid" id="badge-grid"></div>
      </div>

      <button class="btn btn-secondary" id="btn-badges-back">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
    </section>

    <!-- Leaderboard screen -->
    <section class="screen" id="screen-leaderboard">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">–†–µ–π—Ç–∏–Ω–≥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            <div class="card-subtitle">
              –í –ø—Ä–æ–¥–µ ‚Äî —Ä–µ–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º. –ó–¥–µ—Å—å ‚Äî –¥–µ–º–æ –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω.
            </div>
          </div>
          <div class="pill-inline">
            üèÜ <span id="leaderboard-me-rating">–†–µ–π—Ç–∏–Ω–≥: 100</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="leader-header-row">
          <span>–ú–µ—Å—Ç–æ</span>
          <span>–ò–º—è</span>
          <span>–†–µ–π—Ç–∏–Ω–≥</span>
        </div>
        <div class="leader-list" id="leaderboard-list"></div>
      </div>

      <button class="btn btn-secondary" id="btn-leaderboard-back">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
    </section>
  </main>
</div>

<nav class="bottom-nav">
    <button class="bottom-nav-btn active" data-tab="home">
      <div class="bottom-nav-btn-icon">üè†</div>
      <div class="bottom-nav-btn-label">–ì–ª–∞–≤–Ω–∞—è</div>
    </button>
    <button class="bottom-nav-btn" data-tab="badges">
      <div class="bottom-nav-btn-icon">‚≠ê</div>
      <div class="bottom-nav-btn-label">–ë–µ–π–¥–∂–∏</div>
    </button>
    <button class="bottom-nav-btn" data-tab="game">
      <div class="bottom-nav-btn-icon">üéÆ</div>
      <div class="bottom-nav-btn-label">–î—É—ç–ª—å</div>
    </button>
    <button class="bottom-nav-btn" data-tab="rating">
      <div class="bottom-nav-btn-icon">üèÜ</div>
      <div class="bottom-nav-btn-label">–†–µ–π—Ç–∏–Ω–≥</div>
    </button>
    <button class="bottom-nav-btn" data-tab="profile">
      <div class="bottom-nav-btn-icon">üë§</div>
      <div class="bottom-nav-btn-label">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </button>
  </nav>
  
<!-- overlay: –≤–≤–æ–¥ –∏–º–µ–Ω–∏ -->
<div class="overlay" id="name-overlay">
  <div class="overlay-card">
    <div class="section-title">–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?</div>
    <p style="font-size:13px;opacity:0.8;margin-bottom:8px;">
      –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Telegram-–∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –∞ –∏–º—è –≤ –∏–≥—Ä–µ –≤—ã –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å —Ç–∞–∫,
      –∫–∞–∫ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –æ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–æ—Å—å –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ.
    </p>
    <input id="name-input" type="text" placeholder="–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è"
           style="width:100%;padding:9px 10px;border-radius:999px;border:1px solid var(--border-soft);font-size:14px;outline:none;margin-bottom:8px;">
    <button class="btn btn-primary btn-small" id="btn-name-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<script>
  // ---------- –í–û–ü–†–û–°–´ ----------
  const questionBank = [
    {
      text: "–ö–∞–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –°–ò–ë–£–†–∞ –æ–∑–Ω–∞—á–∞–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –∏ –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞?",
      category: "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
      options: [
        "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —ç–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤",
        "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å",
        "–ö–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞",
        "–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å"
      ],
      correctIndex: 1
    },
    {
      text: "–ß—Ç–æ –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ –ª—É—á—à–µ –≤—Å–µ–≥–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç –∫—É—Ä—Å –°–ò–ë–£–†–∞ –Ω–∞ —É—Å—Ç–æ–π—á–∏–≤–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ?",
      category: "–≠–∫–æ–ª–æ–≥–∏—è –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å",
      options: [
        "–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ–±—ä—ë–º–æ–≤ –ª—é–±—ã—Ö –≤–∏–¥–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞",
        "–û—Ç–∫–∞–∑ –æ—Ç —Ü–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏–∏",
        "–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª–∏–º–µ—Ä–æ–≤ –∏ —Å–Ω–∏–∂–µ–Ω–∏–µ –≤—ã–±—Ä–æ—Å–æ–≤",
        "–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤"
      ],
      correctIndex: 2
    },
    {
      text: "–ß—Ç–æ –≤ –±–æ–ª—å—à–µ–π —Å—Ç–µ–ø–µ–Ω–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω–Ω–æ–≤–∞—Ü–∏—è–º –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ?",
      category: "–ò–Ω–Ω–æ–≤–∞—Ü–∏–∏",
      options: [
        "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π",
        "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞",
        "–ó–∞–ø—Ä–µ—Ç –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—è–º",
        "–°–æ–∫—Ä—ã—Ç–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤"
      ],
      correctIndex: 1
    },
    {
      text: "–ß—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–º–µ—Ä–æ–º –∫–æ–º–∞–Ω–¥–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏?",
      category: "–ö–æ–º–∞–Ω–¥–Ω–æ—Å—Ç—å",
      options: [
        "–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –∫–æ–ª–ª–µ–≥",
        "–°–æ–≤–º–µ—Å—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –º–µ–∂–¥—É —Ü–µ—Ö–∞–º–∏",
        "–°–æ–∫—Ä—ã—Ç–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
        "–†–∞–±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É ¬´–º–æ—è —Å–º–µ–Ω–∞ ‚Äî –º–æ–∏ –∑–∞–¥–∞—á–∏¬ª"
      ],
      correctIndex: 1
    },
        {
      text: "–í—ã –∑–∞–º–µ—Ç–∏–ª–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ß—Ç–æ –≤—ã —Å–¥–µ–ª–∞–µ—Ç–µ?",
      category: "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
      options: [
        "–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π",
        "–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å, –Ω–∞—Ä—É—à–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏",
        "–°–æ–æ–±—â–∏—Ç—å –ø–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º—É –∫–∞–Ω–∞–ª—É –∏ –ø—Ä–∏–Ω—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–µ—Ä—ã",
        "–ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å, –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã ‚Äî –Ω–æ—Ä–º–∞"
      ],
      correctIndex: 2
    },
    {
      text: "–ö–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –ø–æ–º–æ–≥–∞–µ—Ç —Å–Ω–∏–∂–∞—Ç—å –æ—Ç—Ö–æ–¥—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞?",
      category: "–≠–∫–æ–ª–æ–≥–∏—è –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å",
      options: [
        "–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏",
        "–°–∏—Å—Ç–µ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∏ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–µ",
        "–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ–±—ä—ë–º–∞ —É–ø–∞–∫–æ–≤–∫–∏",
        "–û—Ç–∫–∞–∑ –æ—Ç —É—á—ë—Ç–∞ –æ—Ç—Ö–æ–¥–æ–≤"
      ],
      correctIndex: 1
    },
    {
      text: "–ß—Ç–æ —á–∞—â–µ –≤—Å–µ–≥–æ –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏ –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ?",
      category: "–ò–Ω–Ω–æ–≤–∞—Ü–∏–∏",
      options: [
        "–û–±–º–µ–Ω –∏–¥–µ—è–º–∏ –∏ –ø–æ–¥–∞—á–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ —É–ª—É—á—à–µ–Ω–∏—è–º",
        "–ó–∞–ø—Ä–µ—Ç –Ω–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∏–¥–µ–π",
        "–û–∂–∏–¥–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç–æ–ª—å–∫–æ ¬´—Å–≤–µ—Ä—Ö—É¬ª",
        "–ò–∑–æ–ª—è—Ü–∏—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞"
      ],
      correctIndex: 0
    }
  ];

  const badgesConfig = [
    {
      id: "rookie",
      title: "–ù–æ–≤–∏—á–æ–∫ —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π",
      description: "–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ 120 –∏ —Å—ã–≥—Ä–∞–π—Ç–µ 3 –¥—É—ç–ª–∏.",
      condition: (p) => p.rating >= 120 && p.battles >= 3
    },
    {
      id: "safety",
      title: "–ó–Ω–∞—Ç–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏",
      description: "–û—Ç–≤–µ—Ç—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–∏–Ω–∏–º—É–º –≤ 5 –≤–æ–ø—Ä–æ—Å–∞—Ö –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.",
      condition: (p) => p.stats.safetyCorrect >= 5
    },
    {
      id: "eco",
      title: "–≠–∫–æ-–≥–µ—Ä–æ–π",
      description: "–û—Ç–≤–µ—Ç—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–∏–Ω–∏–º—É–º –≤ 5 –≤–æ–ø—Ä–æ—Å–∞—Ö –ø–æ —ç–∫–æ–ª–æ–≥–∏–∏.",
      condition: (p) => p.stats.ecoCorrect >= 5
    },
    {
      id: "innovator",
      title: "–ò–Ω–Ω–æ–≤–∞—Ç–æ—Ä",
      description: "–û—Ç–≤–µ—Ç—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–∏–Ω–∏–º—É–º –≤ 5 –≤–æ–ø—Ä–æ—Å–∞—Ö –ø–æ –∏–Ω–Ω–æ–≤–∞—Ü–∏—è–º.",
      condition: (p) => p.stats.innovationCorrect >= 5
    },
    {
      id: "duelist",
      title: "–ú–∞—Å—Ç–µ—Ä –¥—É—ç–ª–µ–π",
      description: "–í—ã–∏–≥—Ä–∞–π—Ç–µ 10 –¥—É—ç–ª–µ–π.",
      condition: (p) => p.wins >= 10
    }
  ];

  const sampleOpponents = [
    { name: "–ò—Ä–∏–Ω–∞, –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è", rating: 130, initials: "–ò–†" },
    { name: "–ê–Ω–¥—Ä–µ–π, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ", rating: 145, initials: "–ê–ü" },
    { name: "–°–µ—Ä–≥–µ–π, —Ü–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏—è", rating: 160, initials: "–°–¶" },
    { name: "–ú–∞—Ä–∏—è, —ç–∫–æ–ª–æ–≥–∏—è", rating: 155, initials: "–ú–≠" }
  ];

  const demoLeaderboard = [
    { name: "–ê–Ω—Ç–æ–Ω, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ", rating: 180, battles: 14, wins: 9 },
    { name: "–ú–∞—Ä–∏–Ω–∞, —Ñ–∏–Ω–∞–Ω—Å—ã",     rating: 165, battles: 11, wins: 7 },
    { name: "–ò–≥–æ—Ä—å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å", rating: 150, battles: 9,  wins: 6 },
    { name: "–û–ª—å–≥–∞, HR",           rating: 135, battles: 6,  wins: 3 },
    { name: "–î–º–∏—Ç—Ä–∏–π, –ò–¢",         rating: 120, battles: 5,  wins: 3 }
  ];

  // ---------- –ó–í–£–ö–ò (Web Audio) ----------
  const Sound = (() => {
    let ctx = null;
    let unlocked = false;

    function ensureContext() {
      if (!ctx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return null;
        ctx = new AC();
      }
      if (ctx.state === "suspended") ctx.resume();
      unlocked = true;
      return ctx;
    }

    function beep(freq, duration, type = "sine", volume = 0.12) {
      const audioCtx = ensureContext();
      if (!audioCtx || !unlocked) return;
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(volume, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now + duration + 0.02);
    }

    return {
      unlock() { ensureContext(); },
      correct() { beep(880, 0.12, "triangle", 0.18); },
      wrong() { beep(220, 0.18, "sawtooth", 0.22); },
      tick() { beep(1300, 0.05, "square", 0.12); },
      finishWin() { beep(1040, 0.16, "triangle", 0.2); setTimeout(() => beep(1320,0.18,"triangle",0.18),120); },
      finishLose() { beep(260,0.18,"sine",0.18); }
    };
  })();

  // ---------- API-–û–ë–Å–†–¢–ö–ê ----------
  const Api = (() => {
    let serverAvailable = false;

	  const queryBase = new URLSearchParams(location.search).get("apiBase");
const baseFromWindow = typeof window !== "undefined" ? window.SIBUR_API_BASE : null;
const rawApiBase = (queryBase || baseFromWindow || "/api").trim();
const apiBase = rawApiBase.endsWith("/") ? rawApiBase.slice(0, -1) : rawApiBase;

function apiUrl(path) {
return apiBase + (path.startsWith("/") ? path : "/" + path);
}

    async function checkServer() {
      try {
       const res = await fetch(apiUrl("/profile/me"), { method: "GET", credentials: "include" });
        if (!res.ok) throw new Error("status " + res.status);
        serverAvailable = true;
        return true;
      } catch (e) {
        serverAvailable = false;
        console.warn("API not available, using local demo mode", e);
        return false;
      }
    }
	  
    async function getProfile(localPlayer) {
      if (!serverAvailable) return null;
      try {
       const res = await fetch(apiUrl("/profile/me"), { credentials: "include" });
        if (!res.ok) throw new Error("status " + res.status);
        return await res.json();
      } catch (e) {
        console.warn("getProfile failed, fallback to local", e);
        return null;
      }
    }

    async function finishDuel(payload) {
      if (!serverAvailable) return null;
      try {
        const res = await fetch(apiUrl("/duels/finish"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("status " + res.status);
        return await res.json();
      } catch (e) {
        console.warn("finishDuel failed, fallback to local", e);
        return null;
      }
    }

    async function getLeaderboard() {
      if (!serverAvailable) return null;
      try {
        const res = await fetch(apiUrl("/leaderboard?limit=50"), { credentials: "include" });
        if (!res.ok) throw new Error("status " + res.status);
        return await res.json();
      } catch (e) {
        console.warn("getLeaderboard failed, fallback to demo", e);
        return null;
      }
    }

    async function findOpponent(mode) {
  if (!serverAvailable) return null;
  try {
    const res = await fetch(apiUrl("/duels/find-opponent?mode=" + encodeURIComponent(mode)), {
      credentials: "include"
    });
    if (!res.ok) throw new Error("status " + res.status);
    return await res.json(); // –æ–∂–∏–¥–∞–µ–º { opponent: { name, rating?, initials? } } –∏–ª–∏ null
  } catch (e) {
    console.warn("findOpponent failed, fallback to bot", e);
    return null;
  }
}

return {
  serverAvailable: () => serverAvailable,
  checkServer,
  getProfile,
  finishDuel,
  getLeaderboard,
  findOpponent,
	apiBase
    };
  })();

  // ---------- –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–û–ö–ê ----------
  let player = {
    tgId: null,
    name: "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –°–ò–ë–£–†",
    avatarUrl: null,
    rating: 100,
    battles: 0,
    wins: 0,
    losses: 0,
    draws: 0,
    stats: {
      safetyCorrect: 0,
      ecoCorrect: 0,
      innovationCorrect: 0
    },
    badges: []
  };

  let gameState = {
  mode: "quick",
  opponent: null,
  questions: [],
  currentQuestionIndex: 0,
  playerScore: 0,
  opponentScore: 0,
  timerInterval: null,
  timerTimeout: null,
  timerTotalMs: 10000,
  questionAnswered: false,
  isDuelActive: false // —Ñ–ª–∞–≥: –∏–≥—Ä–æ–∫ —Å–µ–π—á–∞—Å –≤ —ç–∫—Ä–∞–Ω–µ –¥—É—ç–ª–∏
};

const MATCH_SEARCH_SECONDS = 30;

const matchmakingState = {
  active: false,
  timeoutId: null,
  intervalId: null
};

function stopMatchmaking() {
  matchmakingState.active = false;

  if (matchmakingState.timeoutId) {
    clearTimeout(matchmakingState.timeoutId);
    matchmakingState.timeoutId = null;
  }
  if (matchmakingState.intervalId) {
    clearInterval(matchmakingState.intervalId);
    matchmakingState.intervalId = null;
  }

  const overlay = $("match-overlay");
  if (overlay) overlay.classList.remove("active");
}

  function $(id) { return document.getElementById(id); }

  function initialsFromName(name) {
    if (!name) return "S";
    const parts = name.split(" ").filter(Boolean);
    if (parts.length === 0) return name[0].toUpperCase();
    if (parts.length === 1) return parts[0][0].toUpperCase();
    return (parts[0][0] + parts[1][0]).toUpperCase();
  }

  function ratingLabel(rating) {
    if (rating < 120) return "–ù–æ–≤–∏—á–æ–∫";
    if (rating < 150) return "–£—á–∞—Å—Ç–Ω–∏–∫";
    if (rating < 200) return "–°–∏–ª—å–Ω—ã–π –∏–≥—Ä–æ–∫";
    if (rating < 250) return "–≠–∫—Å–ø–µ—Ä—Ç";
    return "–õ–µ–≥–µ–Ω–¥–∞";
  }

  function battlesLabel(battles) {
    if (battles === 0) return "0 –¥—É—ç–ª–µ–π";
    if (battles === 1) return "1 –¥—É—ç–ª—å";
    if (battles < 5) return battles + " –¥—É—ç–ª–∏";
    return battles + " –¥—É—ç–ª–µ–π";
  }

  function switchScreen(id) {
    document.querySelectorAll(".screen").forEach(el => {
      el.classList.toggle("active", el.id === id);
    });
  }

	function updateConnectionUI(isOnline, message) {
 const badge = document.querySelector(".header-badge");
 if (badge) {
badge.textContent = isOnline ? "ONLINE" : "DEMO";
badge.classList.remove("badge-online", "badge-demo", "badge-warning");
badge.classList.add(isOnline ? "badge-online" : "badge-demo");
}

const logo = document.querySelector(".header-logo");
if (logo) logo.textContent = "QUIZ BATTLE";

const footer = $("splash-footer");
if (footer) footer.textContent = message;
}
	
  function shuffle(array) {
    const arr = array.slice();
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function storageKey() {
    return player.tgId ? "sibur_quiz_player_" + player.tgId : "sibur_quiz_demo_player";
  }

  function savePlayerLocal() {
    try {
      localStorage.setItem(storageKey(), JSON.stringify(player));
    } catch (e) {}
  }


function updateBadgesFromPlayer() {
  const unlockedIds = [];
  badgesConfig.forEach(b => {
    if (b.condition(player)) unlockedIds.push(b.id);
  });
  player.badges = unlockedIds;
}

  function loadPlayerLocal(tgId) {
    let raw = null;
    if (tgId) {
      raw = localStorage.getItem("sibur_quiz_player_" + tgId);
    }
    if (!raw) {
      raw = localStorage.getItem("sibur_quiz_demo_player");
    }
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      player = Object.assign(player, data);
    } catch (e) {}
  }

function updateMainScreen() {
  $("player-name").textContent = player.name;

  const avatarEl = $("player-avatar");
  avatarEl.innerHTML = "";
  if (player.avatarUrl) {
    const img = document.createElement("img");
    img.src = player.avatarUrl;
    avatarEl.appendChild(img);
  } else {
    avatarEl.textContent = initialsFromName(player.name);
  }

  // —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥ –Ω–∏–∫–æ–º
  $("player-meta").textContent = `–†–µ–π—Ç–∏–Ω–≥: ${player.rating} ¬∑ –î—É—ç–ª–µ–π: ${player.battles}`;

  // —Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∏ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
  const ratingLabelEl = $("player-rating-label");
  const battlesLabelEl = $("player-battles-label");
  if (ratingLabelEl) ratingLabelEl.textContent = ratingLabel(player.rating);
  if (battlesLabelEl) battlesLabelEl.textContent = battlesLabel(player.battles);

  // –ø—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç "–ù–æ–≤–∏—á–æ–∫" –∫ "–≠–∫—Å–ø–µ—Ä—Ç"
  const progressEl = $("home-level-progress");
  if (progressEl) {
    const min = 0;
    const max = 250;
    const value = Math.max(min, Math.min(max, player.rating));
    const ratio = (value - min) / (max - min || 1);
    const width = 10 + ratio * 90; // –æ—Ç 10% –¥–æ 100%
    progressEl.style.width = width + "%";
  }

  // –∫–∞–∫–∞—è –ø–ª–∞—à–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî –ù–æ–≤–∏—á–æ–∫ –∏–ª–∏ –≠–∫—Å–ø–µ—Ä—Ç
  const startPill = $("home-level-start");
  const endPill = $("home-level-end");
  if (startPill && endPill) {
    const isExpert = player.rating >= 150;
    startPill.classList.toggle("active", !isExpert);
    endPill.classList.toggle("active", isExpert);
  }
}
  function updateBadgesFromPlayer() {
    const unlockedIds = [];
    badgesConfig.forEach(b => {
      if (b.condition(player)) unlockedIds.push(b.id);
    });
    player.badges = unlockedIds;
  }

  function renderBadges() {
    updateBadgesFromPlayer();
    const container = $("badge-grid");
    container.innerHTML = "";
    const unlockedSet = new Set(player.badges);
    badgesConfig.forEach(badge => {
      const card = document.createElement("div");
      const unlocked = unlockedSet.has(badge.id);
      card.className = "badge-card" + (unlocked ? "" : " locked");

      const title = document.createElement("div");
      title.textContent = badge.title;
      title.style.fontWeight = "600";
      card.appendChild(title);

      const desc = document.createElement("div");
      desc.textContent = badge.description;
      desc.style.fontSize = "11px";
      desc.style.opacity = "0.8";
      card.appendChild(desc);

      const pill = document.createElement("div");
      pill.className = "badge-pill";
      pill.textContent = unlocked ? "–û—Ç–∫—Ä—ã—Ç–æ" : "–ü–æ–∫–∞ –∑–∞–∫—Ä—ã—Ç–æ";
      card.appendChild(pill);

      container.appendChild(card);
    });

    $("badges-count-label").textContent = `${player.badges.length} –∏–∑ ${badgesConfig.length}`;
  }

  function renderLeaderboard(serverData) {
    const container = $("leaderboard-list");
    container.innerHTML = "";

    let players;
    if (serverData && serverData.items) {
      players = serverData.items.slice();
    } else {
      players = demoLeaderboard.map(p => ({ ...p }));
      players.push({
        name: player.name + " (–≤—ã)",
        rating: player.rating,
        battles: player.battles,
        wins: player.wins
      });
      players.sort((a, b) => b.rating - a.rating);
    }

    players.forEach((p, idx) => {
      const row = document.createElement("div");
      const isMe = p.name.includes("(–≤—ã)") || (serverData && serverData.me && serverData.me.position === idx + 1);
      row.className = "leader-row" + (isMe ? " me" : "");

      const pos = document.createElement("div");
      pos.className = "leader-pos";
      pos.textContent = serverData && p.position ? p.position : (idx + 1);
      row.appendChild(pos);

      const nameCol = document.createElement("div");
      nameCol.className = "leader-name";
      const main = document.createElement("div");
      main.className = "leader-name-main";
      main.textContent = p.name;
      const sub = document.createElement("div");
      sub.className = "leader-name-sub";
      sub.textContent = `–î—É—ç–ª–µ–π: ${p.battles || 0}, –ø–æ–±–µ–¥: ${p.wins || 0}`;
      nameCol.appendChild(main);
      nameCol.appendChild(sub);
      row.appendChild(nameCol);

      const score = document.createElement("div");
      score.className = "leader-score";
      score.textContent = p.rating;
      row.appendChild(score);

      container.appendChild(row);
    });

    $("leaderboard-me-rating").textContent = `–†–µ–π—Ç–∏–Ω–≥: ${player.rating}`;
  }

  function resetTimer() {
    if (gameState.timerInterval) {
      clearInterval(gameState.timerInterval);
      gameState.timerInterval = null;
    }
    if (gameState.timerTimeout) {
      clearTimeout(gameState.timerTimeout);
      gameState.timerTimeout = null;
    }
  }

  function prepareDuel(mode, opponentOverride) {
  gameState.mode = mode;
  gameState.questions = shuffle(questionBank).slice(0, 5);
  gameState.currentQuestionIndex = 0;
  gameState.playerScore = 0;
  gameState.opponentScore = 0;
  gameState.questionAnswered = false;

  let opponentData = opponentOverride;
  if (!opponentData) {
    opponentData = sampleOpponents[Math.floor(Math.random() * sampleOpponents.length)];
  }

  gameState.opponent = {
    name: opponentData.name,
    rating: typeof opponentData.rating === "number" ? opponentData.rating : 140,
    initials: opponentData.initials || initialsFromName(opponentData.name),
    isReal: !!opponentData.isReal
  };

  $("duel-mode-label").textContent =
    mode === "bot" ? "–†–µ–∂–∏–º: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å –ò–ò-—Å–æ–ø–µ—Ä–Ω–∏–∫–æ–º" : "–†–µ–∂–∏–º: –ë—ã—Å—Ç—Ä–∞—è –¥—É—ç–ª—å";

  $("duel-player-name").textContent = "–í—ã";
  $("duel-player-rating").textContent = player.rating;

  const playerAvatar = $("duel-player-avatar");
  if (playerAvatar) {
    playerAvatar.innerHTML = "";
    if (player.avatarUrl) {
      const img = document.createElement("img");
      img.src = player.avatarUrl;
      playerAvatar.appendChild(img);
    } else {
      playerAvatar.textContent = initialsFromName(player.name);
    }
  }

  $("duel-opponent-name").textContent = gameState.opponent.name;
  $("duel-opponent-rating").textContent = gameState.opponent.rating;
  $("duel-opponent-avatar").textContent = gameState.opponent.initials;
  $("duel-score-label").textContent = "0 : 0";

  const hint = $("duel-hint");
  if (hint) {
    if (gameState.opponent.isReal) {
      hint.textContent = "–°–µ–π—á–∞—Å –≤—ã –∏–≥—Ä–∞–µ—Ç–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–ª–ª–µ–≥–æ–π, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ–∂–µ –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.";
    } else if (mode === "bot") {
      hint.textContent = "–°–µ–π—á–∞—Å –≤—ã –∏–≥—Ä–∞–µ—Ç–µ —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–º –ò–ò-—Å–æ–ø–µ—Ä–Ω–∏–∫–æ–º. –†–µ–π—Ç–∏–Ω–≥ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –º—è–≥—á–µ.";
    } else {
      hint.textContent = "–ï—Å–ª–∏ —Å—Ä–µ–¥–∏ –∫–æ–ª–ª–µ–≥ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç, –¥—É—ç–ª—å –∏–≥—Ä–∞–µ—Ç –ò–ò-—Å–æ–ø–µ—Ä–Ω–∏–∫, —á—Ç–æ–±—ã –≤—ã –Ω–µ –∂–¥–∞–ª–∏.";
    }
  }
}

async function startDuel(mode, opponentOverride = null) {
gameState.isDuelActive = true;
  resetTimer();

  gameState.playerScore = 0;
  gameState.opponentScore = 0;
  gameState.currentQuestionIndex = 0;
  gameState.questionAnswered = false;

  prepareDuel(mode, opponentOverride);

  switchScreen("screen-duel");

  const countdownOverlay = $("duel-countdown-overlay");
  const countdownPill = $("duel-countdown-pill");

  if (countdownOverlay && countdownPill) {
    let n = 3;
    countdownOverlay.classList.add("visible");
    countdownPill.textContent = n;

    const interval = setInterval(() => {
      n--;
      if (n <= 0) {
        clearInterval(interval);
        countdownOverlay.classList.remove("visible");
        showQuestion();
      } else {
        countdownPill.textContent = n;
      }
    }, 700);
  } else {
    showQuestion();
  }
}
function startMatchmaking(mode) {
  if (matchmakingState.active) return;

  matchmakingState.active = true;

  const overlay = $("match-overlay");
  const timerEl = $("match-timer");
  const statusEl = $("match-status");

  let secondsLeft = MATCH_SEARCH_SECONDS;

  if (timerEl) timerEl.textContent = String(secondsLeft);
if (statusEl) {
statusEl.textContent = Api.serverAvailable()
? "–ò—â–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ —Å—Ä–µ–¥–∏ –∫–æ–ª–ª–µ–≥, –∫–æ—Ç–æ—Ä—ã–µ —Å–µ–π—á–∞—Å –≤ –∏–≥—Ä–µ‚Ä¶"
: "–†–∞–±–æ—Ç–∞–µ–º –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ: –±—É–¥–µ—Ç –ø–æ–¥–±–æ—Ä –±–æ—Ç–∞, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π API –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥—É—ç–ª–µ–π.";
}
  if (overlay) overlay.classList.add("active");

  matchmakingState.intervalId = setInterval(() => {
    if (!matchmakingState.active) return;
    secondsLeft -= 1;
    if (secondsLeft < 0) secondsLeft = 0;
    if (timerEl) timerEl.textContent = String(secondsLeft);
  }, 1000);

  matchmakingState.timeoutId = setTimeout(() => {
    if (!matchmakingState.active) return;
    stopMatchmaking();
    startDuel(mode); // —Å–æ–ø–µ—Ä–Ω–∏–∫-–±–æ—Ç
  }, MATCH_SEARCH_SECONDS * 1000);

  if (Api.serverAvailable() && typeof Api.findOpponent === "function") {
    Api.findOpponent(mode)
      .then((res) => {
        if (!matchmakingState.active || !res || !res.opponent) return;

        stopMatchmaking();

        const oppRaw = res.opponent;
        const opponent = {
          name: oppRaw.name || "–ö–æ–ª–ª–µ–≥–∞",
          rating: typeof oppRaw.rating === "number" ? oppRaw.rating : 140,
          initials: oppRaw.initials || initialsFromName(oppRaw.name || "K"),
          isReal: true
        };

        startDuel(mode, opponent);
      })
      .catch(() => {
        // –ù–∞ –æ—à–∏–±–∫–µ –ø—Ä–æ—Å—Ç–æ –∂–¥—ë–º 30 —Å–µ–∫ –∏ —É—Ö–æ–¥–∏–º –≤ –±–æ—Ç–∞
      });
  }
}
  function showQuestion() {
  resetTimer();

  const q = gameState.questions[gameState.currentQuestionIndex];
  if (!q) return;

  $("duel-progress-label").textContent =
    `–í–æ–ø—Ä–æ—Å ${gameState.currentQuestionIndex + 1} / ${gameState.questions.length}`;
  $("question-text").textContent = q.text;
  $("question-meta").textContent = "–ö–∞—Ç–µ–≥–æ—Ä–∏—è: " + q.category;
  $("duel-score-label").textContent = `${gameState.playerScore} : ${gameState.opponentScore}`;

  const answersContainer = $("answers-container");
  answersContainer.innerHTML = "";
  gameState.questionAnswered = false;

  q.options.forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.className = "btn answer-btn";
    btn.textContent = opt;
    btn.dataset.index = String(idx);
    btn.addEventListener("click", () => {
      if (gameState.questionAnswered) return;
      gameState.questionAnswered = true;
      resetTimer();
      handlePlayerAnswer(idx, btn);
    });
    answersContainer.appendChild(btn);
  });

  const timerFill = $("timer-fill");
  timerFill.style.width = "100%";

  const total = gameState.timerTotalMs;
  const startedAt = Date.now();

  // –¢–∏–∫ –∏ –∞–Ω–∏–º–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ –¥—É—ç–ª—å –∞–∫—Ç–∏–≤–Ω–∞
  gameState.timerInterval = setInterval(() => {
    if (!gameState.isDuelActive) {
      clearInterval(gameState.timerInterval);
      gameState.timerInterval = null;
      return;
    }

    const elapsed = Date.now() - startedAt;
    const left = Math.max(0, total - elapsed);
    const percent = (left / total) * 100;
    timerFill.style.width = percent + "%";

    if (left <= 1000 && left > 0) {
      Sound.tick();
    }

    if (left <= 0) {
      clearInterval(gameState.timerInterval);
      gameState.timerInterval = null;
    }
  }, 90);

  // –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç –ø–æ —Ç–∞–π–º–µ—Ä—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥—É—ç–ª—å –≤—Å—ë –µ—â—ë –∞–∫—Ç–∏–≤–Ω–∞
  gameState.timerTimeout = setTimeout(() => {
    if (!gameState.isDuelActive) return;
    if (!gameState.questionAnswered) {
      gameState.questionAnswered = true;
      handlePlayerAnswer(null, null, true);
    }
  }, total);
}



 function simulateOpponentAnswer(question) {
  const baseDelay = 1300;
  const extra = Math.random() * 2500;
  const delay = baseDelay + extra;
  const willAnswerCorrect = Math.random() < 0.7;

  setTimeout(() => {
    if (!gameState.isDuelActive) return;

    const idx = gameState.questions.indexOf(question);
    if (idx === -1 || idx !== gameState.currentQuestionIndex) return;
    if (!gameState.questionAnswered) {
      if (willAnswerCorrect) {
        gameState.opponentScore++;
      }
      $("duel-score-label").textContent = `${gameState.playerScore} : ${gameState.opponentScore}`;
    }
  }, delay);
}


  async function handlePlayerAnswer(optionIndex, btn, isTimeout = false) {
    if (gameState.questionAnswered) return;
    gameState.questionAnswered = true;
    resetTimer();

    const q = gameState.questions[gameState.currentQuestionIndex];
    const correctIdx = q.correctIndex;
    const answersButtons = Array.from(document.querySelectorAll("#answers-container .answer-btn"));

    answersButtons.forEach((b) => {
      b.classList.add("disabled");
      const idx = parseInt(b.dataset.index, 10);
      if (idx === correctIdx) {
        b.classList.add("correct");
      }
    });

    let playerCorrect = false;

    if (optionIndex !== null && optionIndex === correctIdx) {
      playerCorrect = true;
      gameState.playerScore++;
      if (btn) btn.classList.add("correct");
      Sound.correct();
    } else if (optionIndex !== null && optionIndex !== correctIdx) {
      if (btn) btn.classList.add("wrong");
      Sound.wrong();
    }

    $("duel-score-label").textContent = `${gameState.playerScore} : ${gameState.opponentScore}`;

    if (playerCorrect) {
      if (q.category.includes("–ë–µ–∑–æ–ø–∞—Å")) {
        player.stats.safetyCorrect++;
      } else if (q.category.includes("–≠–∫–æ–ª–æ–≥")) {
        player.stats.ecoCorrect++;
      } else if (q.category.includes("–ò–Ω–Ω–æ–≤–∞—Ü")) {
        player.stats.innovationCorrect++;
      }
    }

    savePlayerLocal();

    setTimeout(() => {
      gameState.currentQuestionIndex++;
      if (gameState.currentQuestionIndex >= gameState.questions.length) {
        finishDuel();
      } else {
        showQuestion();
      }
    }, 900);
  }

  async function finishDuel() {
    gameState.isDuelActive = false;
    resetTimer();
    const playerScore = gameState.playerScore;
    const opponentScore = gameState.opponentScore;
    const mode = gameState.mode;

    let statusText = "";
    let deltaRating = 0;

    player.battles++;

    if (playerScore > opponentScore) {
      statusText = "–ü–æ–±–µ–¥–∞ üéâ";
      player.wins++;
      deltaRating = mode === "quick" ? 15 : 5;
      Sound.finishWin();
    } else if (playerScore < opponentScore) {
      statusText = "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ ‚Äî –Ω–æ –æ–ø—ã—Ç –µ—Å—Ç—å üí™";
      player.losses++;
      deltaRating = mode === "quick" ? 5 : 3;
      Sound.finishLose();
    } else {
      statusText = "–ù–∏—á—å—è ü§ù";
      player.draws++;
      deltaRating = mode === "quick" ? 10 : 4;
      Sound.finishWin();
    }

    player.rating += deltaRating;
    if (player.rating < 0) player.rating = 0;

    updateBadgesFromPlayer();
    savePlayerLocal();

    // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
    if (Api.serverAvailable()) {
      try {
        const payload = {
          mode,
          score_user: playerScore,
          score_opponent: opponentScore,
          categories_correct: gameState.questions.map((q, idx) => ({
            category: q.category,
            correct: idx < gameState.currentQuestionIndex // —É–ø—Ä–æ—â—ë–Ω–Ω–æ
          }))
        };
        const serverResult = await Api.finishDuel(payload);
        if (serverResult && typeof serverResult.new_rating === "number") {
          player.rating = serverResult.new_rating;
          deltaRating = serverResult.rating_delta || deltaRating;
          player.battles = serverResult.battles ?? player.battles;
          player.wins = serverResult.wins ?? player.wins;
          player.losses = serverResult.losses ?? player.losses;
          player.draws = serverResult.draws ?? player.draws;
          if (serverResult.badges) {
            player.badges = serverResult.badges.map(b => b.code);
          }
          savePlayerLocal();
        }
      } catch (e) {
        console.warn("finishDuel server sync failed", e);
      }
    }

    $("result-score").textContent = `${playerScore} : ${opponentScore}`;
    $("result-status-label").textContent = statusText;
    $("result-delta-label").textContent = `–†–µ–π—Ç–∏–Ω–≥: ${deltaRating >= 0 ? "+" : ""}${deltaRating} ¬∑ –î—É—ç–ª–µ–π: +1`;
    $("result-rating-value").textContent = player.rating;
    $("result-battles-value").textContent = player.battles;
    $("result-wl-value").textContent = `${player.wins} / ${player.losses} / ${player.draws}`;

    $("result-mode-pill").textContent = mode === "quick" ? "–ë—ã—Å—Ç—Ä–∞—è –¥—É—ç–ª—å" : "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞";
    $("result-subtitle").textContent =
      Api.serverAvailable()
        ? "–†–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ —É—á—Ç—ë–Ω –≤ –æ–±—â–µ–º —Å–µ—Ä–≤–µ—Ä–Ω–æ–º —Ä–µ–π—Ç–∏–Ω–≥–µ."
        : "–°–µ–π—á–∞—Å –≤—ã –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ. –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å –º–æ–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å.";

    switchScreen("screen-result");
  }

  // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM + –ó–ê–ì–†–£–ó–ö–ê –ò–ì–†–û–ö–ê ---

  function initTelegram() {
    let tg = null;
    if (window.Telegram && window.Telegram.WebApp) {
      tg = window.Telegram.WebApp;
      tg.ready();
      const user = tg.initDataUnsafe && tg.initDataUnsafe.user;
      if (user) {
        player.tgId = user.id;
        player.avatarUrl = user.photo_url || null;
        loadPlayerLocal(player.tgId);
        if (!player.name || player.name === "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –°–ò–ë–£–†") {
          player.name = user.first_name + (user.last_name ? " " + user.last_name : "");
        }
        savePlayerLocal();
        $("splash-footer").textContent =
          "–ú—ã –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ –≤–∞—Å –ø–æ –∞–∫–∫–∞—É–Ω—Ç—É Telegram. –ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤ –∏–≥—Ä—É.";
      }
    } else {
      // –ó–∞–ø—É—Å–∫ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ ‚Äì –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª—å
      loadPlayerLocal(null);
    }
  }

  function isRegistered() {
    return !!player.name && player.name !== "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –°–ò–ë–£–†";
  }

  function startLoadingSequence() {
    switchScreen("screen-loading");
    const bar = $("loading-progress-bar");
    if (!bar) {
      showNameOverlayIfNeeded();
      return;
    }

    let progress = 0;
    const stepMs = 40;

    const timer = setInterval(() => {
      progress += 3;
      if (progress > 100) progress = 100;

      bar.style.width = progress + "%";
      bar.textContent = progress + "%";

      if (progress >= 100) {
        clearInterval(timer);
        setTimeout(() => {
          if (isRegistered()) {
            updateMainScreen();
            switchScreen("screen-main");
          } else {
            showNameOverlayIfNeeded();
          }
        }, 300);
      }
    }, stepMs);
  }

  function showNameOverlayIfNeeded() {
    if (!player.name || player.name === "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –°–ò–ë–£–†") {
      const input = $("name-input");
      if (input) input.value = "";
      const ov = $("name-overlay");
      if (ov) ov.classList.add("active");
    } else {
      updateMainScreen();
      switchScreen("screen-main");
    }
  }

  async function init() {
    initTelegram();
    updateMainScreen();
    updateBadgesFromPlayer();

    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∑–≤—É–∫ –ø–æ –ø–µ—Ä–≤–æ–º—É –∫–ª–∏–∫—É
    document.body.addEventListener(
      "click",
      () => {
        Sound.unlock();
      },
      { once: true }
    );

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä —Ä–µ–π—Ç–∏–Ω–≥–∞
    Api.checkServer().then((ok) => {
      const baseLabel = ` (API: ${Api.apiBase})`;
if (ok) {
updateConnectionUI(
true,
"–°—Ç–∞—Ç—É—Å: —Å–µ—Ä–≤–µ—Ä —Ä–µ–π—Ç–∏–Ω–≥–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω. –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Ä–µ–π—Ç–∏–Ω–≥ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö." +
baseLabel
);
} else {
updateConnectionUI(
false,
"–°—Ç–∞—Ç—É—Å: —Å–µ—Ä–≤–µ—Ä —Ä–µ–π—Ç–∏–Ω–≥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–µ–º–æ-—Ä–µ–∂–∏–º." + 
	baseLabel
);

     // –ü—Ä–æ–≥—Ä–µ–≤ –±–∞–∑—ã: —Å—Ä–∞–∑—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ª–∏–¥–µ—Ä–±–æ—Ä–¥
      if (ok) {
        Api.getLeaderboard().catch((err) => {
          console.warn("DB warmup (getLeaderboard) failed", err);
        });
      }
    });

    // –ö–Ω–æ–ø–∫–∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è¬ª
    const btnNameSave = $("btn-name-save");
    if (btnNameSave) {
      btnNameSave.addEventListener("click", () => {
        const input = $("name-input");
        if (!input) return;
        const name = input.value.trim();
        if (!name) return;
        player.name = name;
        savePlayerLocal();
        const ov = $("name-overlay");
        if (ov) ov.classList.remove("active");
        updateMainScreen();
        switchScreen("screen-main");
      });
    }

    // –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
    const btnQuick = $("btn-play-quick");
    if (btnQuick) {
      btnQuick.addEventListener("click", () => startMatchmaking("quick"));
    }
	
// –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∞" –Ω–∞ –æ–≤–µ—Ä–ª–µ–µ –ø–æ–∏—Å–∫–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
const btnMatchCancel = $("btn-match-cancel");
if (btnMatchCancel) {
  btnMatchCancel.addEventListener("click", () => {
    stopMatchmaking();
  });
}

    const btnBot = $("btn-play-bot");
    if (btnBot) {
      btnBot.addEventListener("click", () => startDuel("bot"));
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –≤ –Ω–∏–∂–Ω–µ–º –º–µ–Ω—é
    const bottomNavButtons = document.querySelectorAll(".bottom-nav-btn[data-tab]");
    bottomNavButtons.forEach((btn) => {
      btn.addEventListener("click", async () => {
        const tab = btn.dataset.tab;

        bottomNavButtons.forEach((b) => {
          b.classList.toggle("active", b === btn);
        });
// –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ –Ω–∏–∂–Ω–µ–º—É –º–µ–Ω—é –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∏—Å–∫ –∏ —Ç–∞–π–º–µ—Ä—ã
stopMatchmaking();
gameState.isDuelActive = false;
resetTimer();

        if (tab === "home") {
          updateMainScreen();
          switchScreen("screen-main");
        } else if (tab === "badges") {
          renderBadges();
          switchScreen("screen-badges");
        } else if (tab === "game") {
          startMatchmaking("quick");
        } else if (tab === "rating") {
          let serverData = null;
          if (Api.serverAvailable()) {
            serverData = await Api.getLeaderboard();
          }
          renderLeaderboard(serverData);
          switchScreen("screen-leaderboard");
        } else if (tab === "profile") {
          const input = $("name-input");
          if (input) input.value = player.name || "";
          const ov = $("name-overlay");
          if (ov) ov.classList.add("active");
        }
      });
    });

    const btnBadgesBack = $("btn-badges-back");
    if (btnBadgesBack) {
      btnBadgesBack.addEventListener("click", () => {
        updateMainScreen();
        switchScreen("screen-main");
      });
    }

    const btnLeaderboardBack = $("btn-leaderboard-back");
    if (btnLeaderboardBack) {
      btnLeaderboardBack.addEventListener("click", () => {
        updateMainScreen();
        switchScreen("screen-main");
      });
    }

    const btnExit = $("btn-duel-exit");
    if (btnExit) {
      btnExit.addEventListener("click", () => {
  gameState.isDuelActive = false;
  resetTimer();
  updateMainScreen();
  switchScreen("screen-main");
});
}

    const btnSkip = $("btn-duel-skip");
    if (btnSkip) {
      btnSkip.addEventListener("click", () => {
        resetTimer();
        finishDuel();
      });
    }

    const btnAgain = $("btn-result-again");
    if (btnAgain) {
      btnAgain.addEventListener("click", () => {
        updateMainScreen();
        startDuel("quick");
      });
    }

    const btnResultMain = $("btn-result-main");
    if (btnResultMain) {
      btnResultMain.addEventListener("click", () => {
        updateMainScreen();
        switchScreen("screen-main");
      });
    }


    // –í —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ ‚Äî –∑–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
    startLoadingSequence();
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
